steps:
  #
  # Shellcheck!
  #
  - label: "Shellcheck :bash:"
    command:
      - ./test/shellcheck.sh
    agents:
      queue: 'docker-privileged'
    plugins:
      docker#v2.1.0:
        image: "chefes/buildkite"

  - label: "[unit] builder-api-client"
    command:
      - hab pkg install core/libarchive
      - hab pkg install core/libsodium
      - hab pkg install core/openssl
      - export LIBARCHIVE_LIB_DIR=$(hab pkg path core/libarchive)/lib
      - export LIBARCHIVE_INCLUDE_DIR=$(hab pkg path core/libarchive)/include
      - export LIBARCHIVE_STATIC=true
      - export SODIUM_LIB_DIR=$(hab pkg path core/libsodium)/lib
      - export SODIUM_STATIC=true
      - export OPENSSL_LIB_DIR=$(hab pkg path core/openssl)/lib
      - export OPENSSL_INCLUDE_DIR=$(hab pkg path core/openssl)/include
      - export OPENSSL_STATIC=true
      - cd components/builder-api-client && cargo test
    agents:
      queue: 'docker-privileged'
    plugins:
      docker#v2.1.0:
        image: "chefes/buildkite"

  - label: "[unit] butterfly"
    command:
      - apt-get update -y && apt-get install libzmq3-dev -y
      - hab pkg install core/libarchive
      - hab pkg install core/libsodium
      - hab pkg install core/openssl
      - hab pkg install core/zeromq
      - export LIBARCHIVE_LIB_DIR=$(hab pkg path core/libarchive)/lib
      - export LIBARCHIVE_INCLUDE_DIR=$(hab pkg path core/libarchive)/include
      - export LIBARCHIVE_STATIC=true
      - export SODIUM_LIB_DIR=$(hab pkg path core/libsodium)/lib
      - export SODIUM_STATIC=true
      - export OPENSSL_LIB_DIR=$(hab pkg path core/openssl)/lib
      - export OPENSSL_INCLUDE_DIR=$(hab pkg path core/openssl)/include
      - export OPENSSL_STATIC=true
      - export LIBZMQ_PREFIX=$(hab pkg path core/zeromq)
      - cd components/butterfly && cargo test
    agents:
      queue: 'docker-privileged'
    plugins:
      docker#v2.1.0:
        image: "chefes/buildkite"

  - label: "[unit] common"
    command:
      - hab pkg install core/zlib
      - hab pkg install core/xz
      - hab pkg install core/bzip2
      - hab pkg install core/libarchive
      - hab pkg install core/libsodium
      - hab pkg install core/openssl
      - export LIBARCHIVE_LIB_DIR=$(hab pkg path core/libarchive)/lib
      - export LIBARCHIVE_INCLUDE_DIR=$(hab pkg path core/libarchive)/include
      - export LIBARCHIVE_LDFLAGS="-L$(pkg_path_for zlib)/lib -lz -L$(pkg_path_for xz)/lib -llzma -L$(pkg_path_for bzip2)/lib -lbz2 -L$(pkg_path_for openssl)/lib -lssl -lcrypto"
      - export LIBARCHIVE_STATIC=true
      - export SODIUM_LIB_DIR=$(hab pkg path core/libsodium)/lib
      - export SODIUM_STATIC=true
      - export OPENSSL_LIB_DIR=$(hab pkg path core/openssl)/lib
      - export OPENSSL_INCLUDE_DIR=$(hab pkg path core/openssl)/include
      - cd components/common && cargo test
    agents:
      queue: 'docker-privileged'
    plugins:
      docker#v2.1.0:
        image: "chefes/buildkite"

  - label: "[unit] eventsrv"
    command:
      - apt-get update -y && apt-get install libzmq3-dev -y
      - hab pkg install core/libarchive
      - hab pkg install core/libsodium
      - hab pkg install core/openssl
      - hab pkg install core/zeromq
      - hab pkg install core/protobuf --binlink
      - export LIBARCHIVE_LIB_DIR=$(hab pkg path core/libarchive)/lib
      - export LIBARCHIVE_INCLUDE_DIR=$(hab pkg path core/libarchive)/include
      - export LIBARCHIVE_STATIC=true
      - export SODIUM_LIB_DIR=$(hab pkg path core/libsodium)/lib
      - export SODIUM_STATIC=true
      - export OPENSSL_LIB_DIR=$(hab pkg path core/openssl)/lib
      - export OPENSSL_INCLUDE_DIR=$(hab pkg path core/openssl)/include
      - export OPENSSL_STATIC=true
      - export LIBZMQ_PREFIX=$(hab pkg path core/zeromq)
      - cd components/eventsrv && cargo test
    agents:
      queue: 'docker-privileged'
    plugins:
      docker#v2.1.0:
        image: "chefes/buildkite"

  - label: "[unit] eventsrv-client"
    command:
      - apt-get update -y && apt-get install libzmq3-dev -y
      - hab pkg install core/libarchive
      - hab pkg install core/libsodium
      - hab pkg install core/openssl
      - hab pkg install core/zeromq
      - export LIBARCHIVE_LIB_DIR=$(hab pkg path core/libarchive)/lib
      - export LIBARCHIVE_INCLUDE_DIR=$(hab pkg path core/libarchive)/include
      - export LIBARCHIVE_STATIC=true
      - export SODIUM_LIB_DIR=$(hab pkg path core/libsodium)/lib
      - export SODIUM_STATIC=true
      - export OPENSSL_LIB_DIR=$(hab pkg path core/openssl)/lib
      - export OPENSSL_INCLUDE_DIR=$(hab pkg path core/openssl)/include
      - export OPENSSL_STATIC=true
      - export LIBZMQ_PREFIX=$(hab pkg path core/zeromq)
      - cd components/eventsrv-client && cargo test
    agents:
      queue: 'docker-privileged'
    plugins:
      docker#v2.1.0:
        image: "chefes/buildkite"

  - label: "[unit] eventsrv-protocol"
    command:
      - hab pkg install core/libarchive
      - hab pkg install core/libsodium
      - hab pkg install core/openssl
      - hab pkg install core/protobuf --binlink
      - export LIBARCHIVE_LIB_DIR=$(hab pkg path core/libarchive)/lib
      - export LIBARCHIVE_INCLUDE_DIR=$(hab pkg path core/libarchive)/include
      - export LIBARCHIVE_STATIC=true
      - export SODIUM_LIB_DIR=$(hab pkg path core/libsodium)/lib
      - export SODIUM_STATIC=true
      - export OPENSSL_LIB_DIR=$(hab pkg path core/openssl)/lib
      - export OPENSSL_INCLUDE_DIR=$(hab pkg path core/openssl)/include
      - export OPENSSL_STATIC=true
      - cd components/eventsrv-protocol && cargo test
    agents:
      queue: 'docker-privileged'
    plugins:
      docker#v2.1.0:
        image: "chefes/buildkite"

  - label: "[unit] hab"
    command:
      - hab pkg install core/libarchive
      - hab pkg install core/libsodium
      - hab pkg install core/openssl
      - export LIBARCHIVE_LIB_DIR=$(hab pkg path core/libarchive)/lib
      - export LIBARCHIVE_INCLUDE_DIR=$(hab pkg path core/libarchive)/include
      - export LIBARCHIVE_STATIC=true
      - export SODIUM_LIB_DIR=$(hab pkg path core/libsodium)/lib
      - export SODIUM_STATIC=true
      - export OPENSSL_LIB_DIR=$(hab pkg path core/openssl)/lib
      - export OPENSSL_INCLUDE_DIR=$(hab pkg path core/openssl)/include
      - export OPENSSL_STATIC=true
      - cd components/hab && cargo test
    agents:
      queue: 'docker-privileged'
    plugins:
      docker#v2.1.0:
        image: "chefes/buildkite"

  - label: "[unit] launcher-client"
    command:
      - hab pkg install core/libarchive
      - hab pkg install core/libsodium
      - hab pkg install core/openssl
      - export LIBARCHIVE_LIB_DIR=$(hab pkg path core/libarchive)/lib
      - export LIBARCHIVE_INCLUDE_DIR=$(hab pkg path core/libarchive)/include
      - export LIBARCHIVE_STATIC=true
      - export SODIUM_LIB_DIR=$(hab pkg path core/libsodium)/lib
      - export SODIUM_STATIC=true
      - export OPENSSL_LIB_DIR=$(hab pkg path core/openssl)/lib
      - export OPENSSL_INCLUDE_DIR=$(hab pkg path core/openssl)/include
      - export OPENSSL_STATIC=true
      - cd components/launcher-client && cargo test
    agents:
      queue: 'docker-privileged'
    plugins:
      docker#v2.1.0:
        image: "chefes/buildkite"

  - label: "[unit] launcher-protocol"
    command:
      - hab pkg install core/libarchive
      - hab pkg install core/libsodium
      - hab pkg install core/openssl
      - export LIBARCHIVE_LIB_DIR=$(hab pkg path core/libarchive)/lib
      - export LIBARCHIVE_INCLUDE_DIR=$(hab pkg path core/libarchive)/include
      - export LIBARCHIVE_STATIC=true
      - export SODIUM_LIB_DIR=$(hab pkg path core/libsodium)/lib
      - export SODIUM_STATIC=true
      - export OPENSSL_LIB_DIR=$(hab pkg path core/openssl)/lib
      - export OPENSSL_INCLUDE_DIR=$(hab pkg path core/openssl)/include
      - export OPENSSL_STATIC=true
      - cd components/launcher-protocol && cargo test
    agents:
      queue: 'docker-privileged'
    plugins:
      docker#v2.1.0:
        image: "chefes/buildkite"

  - label: "[unit] pkg-export-docker"
    command:
      - hab pkg install core/libarchive
      - hab pkg install core/libsodium
      - hab pkg install core/openssl
      - export LIBARCHIVE_LIB_DIR=$(hab pkg path core/libarchive)/lib
      - export LIBARCHIVE_INCLUDE_DIR=$(hab pkg path core/libarchive)/include
      - export LIBARCHIVE_STATIC=true
      - export SODIUM_LIB_DIR=$(hab pkg path core/libsodium)/lib
      - export SODIUM_STATIC=true
      - export OPENSSL_LIB_DIR=$(hab pkg path core/openssl)/lib
      - export OPENSSL_INCLUDE_DIR=$(hab pkg path core/openssl)/include
      - export OPENSSL_STATIC=true
      - cd components/pkg-export-docker && cargo test
    agents:
      queue: 'docker-privileged'
    plugins:
      docker#v2.1.0:
        image: "chefes/buildkite"

  - label: "[unit] pkg-export-helm"
    command:
      - hab pkg install core/libarchive
      - hab pkg install core/libsodium
      - hab pkg install core/openssl
      - export LIBARCHIVE_LIB_DIR=$(hab pkg path core/libarchive)/lib
      - export LIBARCHIVE_INCLUDE_DIR=$(hab pkg path core/libarchive)/include
      - export LIBARCHIVE_STATIC=true
      - export SODIUM_LIB_DIR=$(hab pkg path core/libsodium)/lib
      - export SODIUM_STATIC=true
      - export OPENSSL_LIB_DIR=$(hab pkg path core/openssl)/lib
      - export OPENSSL_INCLUDE_DIR=$(hab pkg path core/openssl)/include
      - export OPENSSL_STATIC=true
      - cd components/pkg-export-helm && cargo test
    agents:
      queue: 'docker-privileged'
    plugins:
      docker#v2.1.0:
        image: "chefes/buildkite"

  - label: "[unit] pkg-export-kubernetes"
    command:
      - hab pkg install core/libarchive
      - hab pkg install core/libsodium
      - hab pkg install core/openssl
      - export LIBARCHIVE_LIB_DIR=$(hab pkg path core/libarchive)/lib
      - export LIBARCHIVE_INCLUDE_DIR=$(hab pkg path core/libarchive)/include
      - export LIBARCHIVE_STATIC=true
      - export SODIUM_LIB_DIR=$(hab pkg path core/libsodium)/lib
      - export SODIUM_STATIC=true
      - export OPENSSL_LIB_DIR=$(hab pkg path core/openssl)/lib
      - export OPENSSL_INCLUDE_DIR=$(hab pkg path core/openssl)/include
      - export OPENSSL_STATIC=true
      - cd components/pkg-export-kubernetes && cargo test
    agents:
      queue: 'docker-privileged'
    plugins:
      docker#v2.1.0:
        image: "chefes/buildkite"

  - label: "[unit] pkg-export-tar"
    command:
      - hab pkg install core/libarchive
      - hab pkg install core/libsodium
      - hab pkg install core/openssl
      - export LIBARCHIVE_LIB_DIR=$(hab pkg path core/libarchive)/lib
      - export LIBARCHIVE_INCLUDE_DIR=$(hab pkg path core/libarchive)/include
      - export LIBARCHIVE_STATIC=true
      - export SODIUM_LIB_DIR=$(hab pkg path core/libsodium)/lib
      - export SODIUM_STATIC=true
      - export OPENSSL_LIB_DIR=$(hab pkg path core/openssl)/lib
      - export OPENSSL_INCLUDE_DIR=$(hab pkg path core/openssl)/include
      - export OPENSSL_STATIC=true
      - cd components/pkg-export-tar && cargo test
    agents:
      queue: 'docker-privileged'
    plugins:
      docker#v2.1.0:
        image: "chefes/buildkite"

  - label: "[unit] sup"
    command:
      - apt-get update -y && apt-get install libzmq3-dev -y
      - hab pkg install core/libarchive
      - hab pkg install core/libsodium
      - hab pkg install core/openssl
      - hab pkg install core/zeromq
      - export LIBARCHIVE_LIB_DIR=$(hab pkg path core/libarchive)/lib
      - export LIBARCHIVE_INCLUDE_DIR=$(hab pkg path core/libarchive)/include
      - export LIBARCHIVE_STATIC=true
      - export SODIUM_LIB_DIR=$(hab pkg path core/libsodium)/lib
      - export SODIUM_STATIC=true
      - export OPENSSL_LIB_DIR=$(hab pkg path core/openssl)/lib
      - export OPENSSL_INCLUDE_DIR=$(hab pkg path core/openssl)/include
      - export OPENSSL_STATIC=true
      - export LIBZMQ_PREFIX=$(hab pkg path core/zeromq)
      - cd components/sup && cargo test
    agents:
      queue: 'docker-privileged'
    plugins:
      docker#v2.1.0:
        image: "chefes/buildkite"

  - label: "[unit] sup-client"
    command:
      - hab pkg install core/libarchive
      - hab pkg install core/libsodium
      - hab pkg install core/openssl
      - export LIBARCHIVE_LIB_DIR=$(hab pkg path core/libarchive)/lib
      - export LIBARCHIVE_INCLUDE_DIR=$(hab pkg path core/libarchive)/include
      - export LIBARCHIVE_STATIC=true
      - export SODIUM_LIB_DIR=$(hab pkg path core/libsodium)/lib
      - export SODIUM_STATIC=true
      - export OPENSSL_LIB_DIR=$(hab pkg path core/openssl)/lib
      - export OPENSSL_INCLUDE_DIR=$(hab pkg path core/openssl)/include
      - export OPENSSL_STATIC=true
      - cd components/sup-client && cargo test
    agents:
      queue: 'docker-privileged'
    plugins:
      docker#v2.1.0:
        image: "chefes/buildkite"

  - label: "[unit] sup-protocol"
    command:
      - hab pkg install core/libarchive
      - hab pkg install core/libsodium
      - hab pkg install core/openssl
      - export LIBARCHIVE_LIB_DIR=$(hab pkg path core/libarchive)/lib
      - export LIBARCHIVE_INCLUDE_DIR=$(hab pkg path core/libarchive)/include
      - export LIBARCHIVE_STATIC=true
      - export SODIUM_LIB_DIR=$(hab pkg path core/libsodium)/lib
      - export SODIUM_STATIC=true
      - export OPENSSL_LIB_DIR=$(hab pkg path core/openssl)/lib
      - export OPENSSL_INCLUDE_DIR=$(hab pkg path core/openssl)/include
      - export OPENSSL_STATIC=true
      - cd components/sup-protocol && cargo test
    agents:
      queue: 'docker-privileged'
    plugins:
      docker#v2.1.0:
        image: "chefes/buildkite"
