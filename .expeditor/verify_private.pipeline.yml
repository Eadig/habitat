expeditor:
  defaults:
    buildkite:
      timeout_in_minutes: 30

# TODO: These tests are currently in the private pipeline because 
# we don't have windows set up in the public infra yet!

steps:
#######################################################################
# Linting!
#######################################################################

- label: "[lint] :windows: :paperclip: clippy!"
  command:
    - .\test\run_clippy.ps1 stable .\test\unexamined_lints.txt .\test\allowed_lints.txt .\test\lints_to_fix.txt .\test\denied_lints.txt
  agents:
    queue: 'single-use-windows-privileged'
  timeout_in_minutes: 25
  retry:
    automatic:
      limit: 1

#######################################################################
# Unit Tests - Windows!
#######################################################################

  - label: "[unit] :windows: builder-api-client"
    command:
      - ./test/run_cargo_test.ps1 builder-api-client
    agents:
      queue: 'single-use-windows-privileged'
    timeout_in_minutes: 25
    retry:
      automatic:
        limit: 1

  - label: "[unit] :windows: butterfly"
    command:
      - ./test/run_cargo_test.ps1 butterfly -Features "ignore_inconsistent_tests" -TestOptions "--test-threads=1"
    agents:
      queue: 'single-use-windows-privileged'
    timeout_in_minutes: 12 # the butterfly tests usually pass in ~10m
    retry:
      automatic:
        limit: 1

  - label: "[unit][inconsistent] :windows: butterfly"
    command:
      - ./test/run_cargo_test.ps1 butterfly -TestOptions "--test-threads=1"
    agents:
      queue: 'single-use-windows-privileged'
    timeout_in_minutes: 12 # the butterfly tests usually pass in ~10m
    retry:
      automatic:
        limit: 10

  - label: "[unit] :windows: common"
    command:
      - ./test/run_cargo_test.ps1 common -TestOptions "--test-threads=1"
    agents:
      queue: 'single-use-windows-privileged'
    timeout_in_minutes: 20
    retry:
      automatic:
        limit: 1

  - label: "[unit] :windows: hab"
    command:
      - ./test/run_cargo_test.ps1 hab
    agents:
      queue: 'single-use-windows-privileged'
    timeout_in_minutes: 20
    retry:
      automatic:
        limit: 1

  - label: "[unit] :windows: launcher-client"
    command:
      - ./test/run_cargo_test.ps1 launcher-client
    agents:
      queue: 'single-use-windows-privileged'
    timeout_in_minutes: 10
    retry:
      automatic:
        limit: 1

  - label: "[unit] :windows: launcher-protocol"
    command:
      - ./test/run_cargo_test.ps1 launcher-protocol
    agents:
      queue: 'single-use-windows-privileged'
    timeout_in_minutes: 10
    retry:
      automatic:
        limit: 1

  - label: "[unit] :windows: pkg-export-docker"
    command:
      - ./test/run_cargo_test.ps1 pkg-export-docker
    agents:
      queue: 'single-use-windows-privileged'
    timeout_in_minutes: 20
    retry:
      automatic:
        limit: 1

  - label: "[unit] :windows: pkg-export-tar"
    command:
      - ./test/run_cargo_test.ps1 pkg-export-tar
    agents:
      queue: 'single-use-windows-privileged'
    timeout_in_minutes: 20
    retry:
      automatic:
        limit: 1

  - label: "[unit] :windows: sup"
    command:
      # This test has test (not code) concurrency issues and will fail if we don't limit it
      - ./test/run_cargo_test.ps1 sup -TestOptions "--test-threads=1"
    agents:
      queue: 'single-use-windows-privileged'
    timeout_in_minutes: 40
    retry:
      automatic:
        limit: 1

  - label: "[unit] :windows: sup-client"
    command:
      - ./test/run_cargo_test.ps1 sup-client
    agents:
      queue: 'single-use-windows-privileged'
    timeout_in_minutes: 20
    retry:
      automatic:
        limit: 1

  - label: "[unit] :windows: sup-protocol"
    command:
      - ./test/run_cargo_test.ps1 sup-protocol
    agents:
      queue: 'single-use-windows-privileged'
    timeout_in_minutes: 20
    retry:
      automatic:
        limit: 1

#######################################################################
# Things that have no tests but should be built to make sure they
# still build. - Windows
#######################################################################

  - label: "[build] :windows: bintray-publish"
    command:
      - ./support/ci/build_component.ps1 bintray-publish
    agents:
      queue: 'single-use-windows-privileged'
    retry:
      automatic:
        limit: 1

  - label: "[build] :windows: hab"
    command:
      - ./support/ci/build_component.ps1 hab
    agents:
      queue: 'single-use-windows-privileged'
    retry:
      automatic:
        limit: 1

  - label: "[build] :windows: launcher"
    command:
      - ./support/ci/build_component.ps1 launcher
    agents:
      queue: 'single-use-windows-privileged'
    retry:
      automatic:
        limit: 1

  - label: "[build] :windows: pkg-export-docker"
    command:
      - ./support/ci/build_component.ps1 pkg-export-docker
    agents:
      queue: 'single-use-windows-privileged'
    retry:
      automatic:
        limit: 1

  - label: "[build] :windows: pkg-export-tar"
    command:
      - ./support/ci/build_component.ps1 pkg-export-tar
    agents:
      queue: 'single-use-windows-privileged'
    retry:
      automatic:
        limit: 1

  - label: "[build] :windows: plan-build-ps1"
    command:
      - ./support/ci/build_component.ps1 plan-build-ps1
    agents:
      queue: 'single-use-windows-privileged'
    retry:
      automatic:
        limit: 1

  - label: "[build] :windows: studio"
    command:
      - ./support/ci/build_component.ps1 studio
    agents:
      queue: 'single-use-windows-privileged'
    retry:
      automatic:
        limit: 1

  - label: "[build] :windows: sup"
    command:
      - ./support/ci/build_component.ps1 sup
    agents:
      queue: 'single-use-windows-privileged'
    retry:
      automatic:
        limit: 1

  - label: "[build] :windows: windows-service"
    command:
      - ./support/ci/build_component.ps1 windows-service
    agents:
      queue: 'single-use-windows-privileged'
    retry:
      automatic:
        limit: 1

