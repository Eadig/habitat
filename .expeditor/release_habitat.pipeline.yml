env:
  HAB_LICENSE: "accept-no-persist"
expeditor:
  defaults:
    buildkite:
      timeout_in_minutes: 30
    executor:
      docker:

steps:
#######################################################################
# Release!
#######################################################################

  - label: "[build hab]"
    command:
      - .expeditor/scripts/build_component.sh hab
    # retry:
    #   automatic:
    #     limit: 1
    expeditor:
      secrets:
        SCOTTHAIN_HAB_AUTH_TOKEN:
          path: account/static/habitat/chef-ci
          field: scotthain-sig-key
      executor:
        docker:
          privileged: true
          environment:
            - HAB_ORIGIN=core
            - HAB_LICENSE="accept-no-persist"
            - HAB_STUDIO_SECRET_HAB_LICENSE="accept-no-persist"
            - HAB_BLDR_URL=https://bldr.acceptance.habitat.sh

  - label: ":windows: [build hab]"
    command:
      - .expeditor/scripts/build_component.ps1 -Component hab
    # retry:
    #   automatic:
    #     limit: 1
    agents:
      queue: 'default-windows-privileged'
    plugins:
      docker#v3.0.1:
        image: "chefes/buildkite-windows"
        shell: [ "powershell", "-Command" ]
        environment:
          - HAB_ORIGIN=core
          - HAB_LICENSE="accept-no-persist"
          - HAB_STUDIO_SECRET_HAB_LICENSE="accept-no-persist"
          - HAB_BLDR_URL=https://bldr.acceptance.habitat.sh
